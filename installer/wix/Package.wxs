<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package
    Name="Sonde Hub"
    Manufacturer="Sonde"
    Version="$(var.Version)"
    UpgradeCode="e8f3a1b2-7c4d-4e5f-9a6b-8d2c1e0f3a4b"
    Scope="perMachine"
    Language="1033"
    Codepage="1252">

    <SummaryInformation
      Description="Sonde Hub â€” AI Infrastructure Agent Server"
      Keywords="Sonde,Hub,MCP,AI" />

    <MajorUpgrade
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A newer version of Sonde Hub is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <Feature Id="HubFeature" Title="Sonde Hub" Level="1">
      <ComponentGroupRef Id="NodeRuntime" />
      <ComponentGroupRef Id="HubAppFiles" />
      <ComponentGroupRef Id="HubServiceComponents" />
      <ComponentGroupRef Id="DataDirectoryComponents" />
      <ComponentRef Id="RememberProperties" />
    </Feature>

    <!--
      Custom action: run setup-env.cjs after install to generate
      SONDE_SECRET if the env file doesn't exist yet.
      Uses WiX Util extension's WixQuietExec64 for deferred execution
      as SYSTEM (required for ProgramData write access).
    -->
    <SetProperty
      Id="RunSetupEnv"
      Value="&quot;[INSTALLFOLDER]node\node.exe&quot; &quot;[INSTALLFOLDER]app\installer-scripts\setup-env.cjs&quot; --mode [SONDE_SECRET_MODE] --azure-keyvault-url &quot;[AZURE_KEYVAULT_URL]&quot; --azure-keyvault-secret-name [AZURE_KEYVAULT_SECRET_NAME] --azure-auth-method [AZURE_AUTH_METHOD] --azure-tenant-id &quot;[AZURE_TENANT_ID]&quot; --azure-client-id &quot;[AZURE_CLIENT_ID]&quot; --azure-client-secret &quot;[AZURE_CLIENT_SECRET]&quot;"
      Before="RunSetupEnv"
      Sequence="execute" />

    <CustomAction
      Id="RunSetupEnv"
      BinaryRef="Wix4UtilCA_X64"
      DllEntry="WixQuietExec64"
      Execute="deferred"
      Impersonate="no"
      Return="check" />

    <InstallExecuteSequence>
      <Custom Action="RunSetupEnv" After="InstallFiles"
              Condition="NOT Installed OR REINSTALL" />
    </InstallExecuteSequence>

    <UIRef Id="SondeInstallerUI" />

    <Property Id="SONDE_SECRET_MODE" Value="standalone" Secure="yes">
      <RegistrySearch Id="RememberSecretMode" Root="HKLM"
                      Key="SOFTWARE\Sonde\Hub" Name="SecretMode" Type="raw" />
    </Property>
    <Property Id="AZURE_KEYVAULT_URL" Secure="yes">
      <RegistrySearch Id="RememberVaultUrl" Root="HKLM"
                      Key="SOFTWARE\Sonde\Hub" Name="AzureKeyVaultUrl" Type="raw" />
    </Property>
    <Property Id="AZURE_KEYVAULT_SECRET_NAME" Value="sonde-secret" Secure="yes">
      <RegistrySearch Id="RememberSecretName" Root="HKLM"
                      Key="SOFTWARE\Sonde\Hub" Name="AzureKeyVaultSecretName" Type="raw" />
    </Property>
    <Property Id="AZURE_AUTH_METHOD" Value="managed_identity" Secure="yes">
      <RegistrySearch Id="RememberAuthMethod" Root="HKLM"
                      Key="SOFTWARE\Sonde\Hub" Name="AzureAuthMethod" Type="raw" />
    </Property>
    <Property Id="AZURE_TENANT_ID" Secure="yes">
      <RegistrySearch Id="RememberTenantId" Root="HKLM"
                      Key="SOFTWARE\Sonde\Hub" Name="AzureTenantId" Type="raw" />
    </Property>
    <Property Id="AZURE_CLIENT_ID" Secure="yes">
      <RegistrySearch Id="RememberClientId" Root="HKLM"
                      Key="SOFTWARE\Sonde\Hub" Name="AzureClientId" Type="raw" />
    </Property>
    <Property Id="AZURE_CLIENT_SECRET" Secure="yes" Hidden="yes" />

  </Package>

  <Fragment>
    <Component Id="RememberProperties" Directory="INSTALLFOLDER"
               Guid="4f8a2c6e-b3d1-4e7f-9a5c-8d2e1f0b3a6c">
      <RegistryKey Root="HKLM" Key="SOFTWARE\Sonde\Hub">
        <RegistryValue Name="SecretMode" Value="[SONDE_SECRET_MODE]"
                       Type="string" KeyPath="yes" />
        <RegistryValue Name="AzureKeyVaultUrl" Value="[AZURE_KEYVAULT_URL]"
                       Type="string" />
        <RegistryValue Name="AzureKeyVaultSecretName"
                       Value="[AZURE_KEYVAULT_SECRET_NAME]" Type="string" />
        <RegistryValue Name="AzureAuthMethod" Value="[AZURE_AUTH_METHOD]"
                       Type="string" />
        <RegistryValue Name="AzureTenantId" Value="[AZURE_TENANT_ID]"
                       Type="string" />
        <RegistryValue Name="AzureClientId" Value="[AZURE_CLIENT_ID]"
                       Type="string" />
      </RegistryKey>
    </Component>
  </Fragment>

</Wix>
